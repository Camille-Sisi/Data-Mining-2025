{
  "hash": "64208321dbe22e28612eec85c18215fd",
  "result": {
    "engine": "knitr",
    "markdown": "# Clustering : application sur le RP 2019 {#sec-Clustering-application}\n\n```{=html}\n<!--Pour un rappel des fondements théoriques des techniques de clustering, voir par exemple <a href=\"https://camille-sisi.github.io/Data-Mining-2022/14-Clustering-theorique.html\" target=\"_blank\">ici</a>, ou <a href=\"https://larmarange.github.io/analyse-R/classification-ascendante-hierarchique.html\" target=\"_blank\">là</a>.  \nCes techniques font partie des méthodes d'apprentissage dit non supervisé, il n'y a pas de variable d'intérêt ou variable cible, on cherche plutôt à rassembler des observations qui \"se ressemblent\" mais pas d'expliquer une variable/un phénomène par rapport à d'autres.-->\n```\n\n## Choix des variables et préparation du tableau final\n\nA partir de la base du RP2019, l'objectif de notre analyse est de décrire des groupes de communes qui se ressemblent ou sont relativement homogènes, c'est-à-dire qui ont des caractéristiques proches. Mais, bien sûr, les méthodes de clustering peuvent être appliquées à toutes sortes de problématiques et de données.\n\nPour cela, on doit avoir un tableau avec **n** individus ou observations (lignes) et **p** variables (colonnes), la mesure des variables peut être des effectifs, mais aussi des proportions. L'idée étant de regrouper nos communes en classes homogènes (=*clusters*) en un nombre plus restreint, nos observations sont donc constituées ici par les communes. Il faut ensuite choisir sur quelles caractéristiques on va les regrouper et chercher une certaine homogénéité. Cela peut être à partir de différentes choses selon notre base de données : caractéristiques socio-professionnelles de la personne de référence du ménage, caractéristiques des logements, etc.\n\n### Variable socio-professionnelle caractérisant la personne de référence du ménage\n\nOn va dans cet exemple (communes de Paris et sa petite couronne) s'intéresser aux caractéristiques socio-professionnelles de la population de 15 ans ou plus : on aura en lignes nos **n** communes des 4 départements et en colonnes nos **p** variables d'entrées, soient par exemple le nombre d'habitants, le nombre d'individus qui sont actuellement chômeurs, le nombre de personnes en emploi, le nombre de cadres, etc.\n\nOn va réaliser ici un exemple très simple en ne prenant qu'une variable reconstruite à partir de celle de la catégorie socio-professionnnelle (`CS1`) qui a actuellement 8 modalités et de celle du type d'activité (`TACT`), cela permettant de distinguer les actifs en emploi des chômeurs. Si l'on prend plus de variables, il faut faire attention à ce que certaines modalités ne se recoupent pas entre elles, ou quand l'information est trop proche - par exemple la condition d'emploi et le type d'activité. Pour cela, il faut étudier les corrélations entre les variables finalement obtenues, avec les fonctions `cor()` ou `corrplot(cor())` du package **`corrplot`** par exemple. Mais si le nombre de variables prises en compte est importante, il peut être également plus pertinent de procéder avant la méthode de clustering à une méthode d'analyse factorielle.  \n\nRegardons d'abord pour cette variable - `CS1` - si un regroupement et un recodage des modalités est nécessaire.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Chargement des librairies\nlibrary(tidyverse)\nlibrary(janitor)\nlibrary(gt)\n\n# Chargement des tables\nRP_final <- readRDS(file = \"data/RP_final.Rdata\")\nmeta <- readRDS(file = \"data/meta.Rdata\")\n\n# Appel fonctions\nsource(\"fonctions/fonctions.R\")\n\nmeta %>% \n  select(COD_VAR, COD_MOD, LIB_MOD) %>% \n  filter(COD_VAR %in% c(\"CS1\", \"TACT\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   COD_VAR COD_MOD\n1      CS1       1\n2      CS1       2\n3      CS1       3\n4      CS1       4\n5      CS1       5\n6      CS1       6\n7      CS1       7\n8      CS1       8\n9     TACT      11\n10    TACT      12\n11    TACT      21\n12    TACT      22\n13    TACT      23\n14    TACT      24\n15    TACT      25\n                                                                      LIB_MOD\n1                                                    Agriculteurs exploitants\n2                                 Artisans, commerçants et chefs d'entreprise\n3                           Cadres et professions intellectuelles supérieures\n4                                                  Professions Intermédiaires\n5                                                                    Employés\n6                                                                    Ouvriers\n7                                                                   Retraités\n8                              Autres personnes sans activité professionnelle\n9  Actifs ayant un emploi, y compris sous apprentissage ou en stage rémunéré.\n10                                                                   Chômeurs\n11                                                  Retraités ou préretraités\n12               Élèves, étudiants, stagiaires non rémunéré de 14 ans ou plus\n13                                                            Moins de 14 ans\n14                                                  Femmes ou hommes au foyer\n15                                                            Autres inactifs\n```\n\n\n:::\n\n```{.r .cell-code}\n# Fonction \"tableau\" créée dans la section 6\nRP_final %>% filter(!AGER20 %in% c(\"2\",\"5\", \"10\",\"14\")) %>% \n  tableau(var_quali = CS1, nom_var_quali = \"PCS\") %>% gt()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"ykinhqtmuq\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#ykinhqtmuq table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#ykinhqtmuq thead, #ykinhqtmuq tbody, #ykinhqtmuq tfoot, #ykinhqtmuq tr, #ykinhqtmuq td, #ykinhqtmuq th {\n  border-style: none;\n}\n\n#ykinhqtmuq p {\n  margin: 0;\n  padding: 0;\n}\n\n#ykinhqtmuq .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#ykinhqtmuq .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#ykinhqtmuq .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#ykinhqtmuq .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#ykinhqtmuq .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#ykinhqtmuq .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ykinhqtmuq .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#ykinhqtmuq .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#ykinhqtmuq .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#ykinhqtmuq .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#ykinhqtmuq .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#ykinhqtmuq .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#ykinhqtmuq .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#ykinhqtmuq .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#ykinhqtmuq .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#ykinhqtmuq .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#ykinhqtmuq .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#ykinhqtmuq .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#ykinhqtmuq .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ykinhqtmuq .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#ykinhqtmuq .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#ykinhqtmuq .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#ykinhqtmuq .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ykinhqtmuq .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#ykinhqtmuq .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#ykinhqtmuq .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ykinhqtmuq .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ykinhqtmuq .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#ykinhqtmuq .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ykinhqtmuq .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#ykinhqtmuq .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ykinhqtmuq .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#ykinhqtmuq .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ykinhqtmuq .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#ykinhqtmuq .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ykinhqtmuq .gt_left {\n  text-align: left;\n}\n\n#ykinhqtmuq .gt_center {\n  text-align: center;\n}\n\n#ykinhqtmuq .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#ykinhqtmuq .gt_font_normal {\n  font-weight: normal;\n}\n\n#ykinhqtmuq .gt_font_bold {\n  font-weight: bold;\n}\n\n#ykinhqtmuq .gt_font_italic {\n  font-style: italic;\n}\n\n#ykinhqtmuq .gt_super {\n  font-size: 65%;\n}\n\n#ykinhqtmuq .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#ykinhqtmuq .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#ykinhqtmuq .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#ykinhqtmuq .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#ykinhqtmuq .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#ykinhqtmuq .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#ykinhqtmuq .gt_indent_5 {\n  text-indent: 25px;\n}\n\n#ykinhqtmuq .katex-display {\n  display: inline-flex !important;\n  margin-bottom: 0.75em !important;\n}\n\n#ykinhqtmuq div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {\n  height: 0px !important;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"PCS\">PCS</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"Effectif\">Effectif</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"Pourcentage\">Pourcentage</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"PCS\" class=\"gt_row gt_left\">1</td>\n<td headers=\"Effectif\" class=\"gt_row gt_right\">890.8146</td>\n<td headers=\"Pourcentage\" class=\"gt_row gt_right\">0.0</td></tr>\n    <tr><td headers=\"PCS\" class=\"gt_row gt_left\">2</td>\n<td headers=\"Effectif\" class=\"gt_row gt_right\">187816.5390</td>\n<td headers=\"Pourcentage\" class=\"gt_row gt_right\">3.4</td></tr>\n    <tr><td headers=\"PCS\" class=\"gt_row gt_left\">3</td>\n<td headers=\"Effectif\" class=\"gt_row gt_right\">1202479.4687</td>\n<td headers=\"Pourcentage\" class=\"gt_row gt_right\">21.5</td></tr>\n    <tr><td headers=\"PCS\" class=\"gt_row gt_left\">4</td>\n<td headers=\"Effectif\" class=\"gt_row gt_right\">838616.6681</td>\n<td headers=\"Pourcentage\" class=\"gt_row gt_right\">15.0</td></tr>\n    <tr><td headers=\"PCS\" class=\"gt_row gt_left\">5</td>\n<td headers=\"Effectif\" class=\"gt_row gt_right\">872375.2789</td>\n<td headers=\"Pourcentage\" class=\"gt_row gt_right\">15.6</td></tr>\n    <tr><td headers=\"PCS\" class=\"gt_row gt_left\">6</td>\n<td headers=\"Effectif\" class=\"gt_row gt_right\">416074.6945</td>\n<td headers=\"Pourcentage\" class=\"gt_row gt_right\">7.4</td></tr>\n    <tr><td headers=\"PCS\" class=\"gt_row gt_left\">7</td>\n<td headers=\"Effectif\" class=\"gt_row gt_right\">1020480.0552</td>\n<td headers=\"Pourcentage\" class=\"gt_row gt_right\">18.2</td></tr>\n    <tr><td headers=\"PCS\" class=\"gt_row gt_left\">8</td>\n<td headers=\"Effectif\" class=\"gt_row gt_right\">1055867.3440</td>\n<td headers=\"Pourcentage\" class=\"gt_row gt_right\">18.9</td></tr>\n    <tr><td headers=\"PCS\" class=\"gt_row gt_left\">Total</td>\n<td headers=\"Effectif\" class=\"gt_row gt_right\">5594600.8630</td>\n<td headers=\"Pourcentage\" class=\"gt_row gt_right\">100.0</td></tr>\n  </tbody>\n  \n</table>\n</div>\n```\n\n:::\n:::\n\n\nIl faut donc supprimer la modalité \"1\" qui correspond aux agriculteurs car trop peu représentés sur ce champ, mais pour le reste on peut laisser comme cela.\n\n### Création du tableau de contingence\n\nPour créer le tableau de contigence donnant le nombre d'individus pour chacune des modalités de cette variable et pour chaque commune, on va créer une fonction qu'on va appeler `tab_cont_n`, pour avoir en ligne les communes et en colonne chaque modalité de la variable en question :\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntab_cont_n <- function(data, ..., nom_var, var, prefix_var)\n{\n  tab_n <- data %>% \n            group_by(...) %>%\n            summarise({{ nom_var }} := round(sum(IPONDI))) %>% \n            pivot_wider(names_from = {{ var }}, values_from = {{ nom_var }},\n                        values_fill = 0, names_prefix = prefix_var)\n  \n  return(tab_n)\n}\n```\n:::\n\n\nOn peut l'intégrer dans notre script `fonctions.R` pour pouvoir l'utiliser plus tard en appelant simplement ce fichier en début de code.\n\n  On crée maintenant notre tableau de contingence, en créant comme déjà mentionné une variable croisant l'information sur la catégorie socio-professionnelle et celle sur le statut d'activité regroupé en emploi, chômage, retraités ou autres inactifs.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# On enlève les agriculteurs, , la commune sans dénomination et les moins de 15 ans\ncat_soc <- RP_final %>% \n  filter(CS1!=\"1\" & COM!=\"ZZZZZ\" &!AGER20 %in% c(\"2\",\"5\", \"10\",\"14\")) %>%  \n  mutate(CS_empcho = as.factor(case_when(CS1 == \"2\" & TACT==\"11\" ~ \"Arti_com\",\n                                         CS1 == \"3\" & TACT==\"11\" ~ \"Cadres\",\n                                         CS1 == \"4\" & TACT==\"11\" ~ \"PI\",\n                                         CS1 == \"5\" & TACT==\"11\" ~ \"Employés\",\n                                         CS1 == \"6\" & TACT==\"11\" ~ \"Ouvriers\",\n                                         CS1 != \"7\" & TACT==\"12\" ~ \"Chômeurs\",\n                                         CS1 == \"7\" & TACT==\"21\" ~ \"Retraités\",\n                                         TRUE ~ \"Autres inactifs\"))) %>% \n  tab_cont_n(COM, CS_empcho, nom_var=cat_soc, var=CS_empcho, prefix_var=\"nb_\")\ncat_soc %>% head(10)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 10 × 9\n# Groups:   COM [10]\n   COM   nb_Arti_com `nb_Autres inactifs` nb_Cadres nb_Chômeurs nb_Employés\n   <chr>       <dbl>                <dbl>     <dbl>       <dbl>       <dbl>\n 1 75101         828                 2249      4294         935        1268\n 2 75102        1086                 2320      7056        1375        1761\n 3 75103        1619                 4287     10160        2085        2617\n 4 75104        1247                 4100      7793        1863        2344\n 5 75105        1869                11010     15853        2611        3494\n 6 75106        1788                 8296     10170        1842        2348\n 7 75107        2462                 8257     12641        2165        3603\n 8 75108        1801                 5559      9702        1565        2846\n 9 75109        2736                 7069     19617        3478        4083\n10 75110        2792                11091     24147        6343        6956\n# ℹ 3 more variables: nb_Ouvriers <dbl>, nb_PI <dbl>, nb_Retraités <dbl>\n```\n\n\n:::\n:::\n\n\nOn a donc 136 lignes correspondant à 136 communes de nos 4 départements, et 9 variables.\n\nOn va rajouter le nom des communes comme identifiant dans le tableau, c'est-à-dire dans le nom de la 1ère colonne, avec la fonction `column_to_rownames()`. Cela peut être conseillé pour la procédure de clustering, afin que chaque commune soit bien identifiée par son nom (label) ; on verra toutefois dans notre exemple que cela devient illisible si on a trop de communes/individus.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncat_soc <- cat_soc %>% column_to_rownames(var = \"COM\")\ncat_soc\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      nb_Arti_com nb_Autres inactifs nb_Cadres nb_Chômeurs nb_Employés\n75101         828               2249      4294         935        1268\n75102        1086               2320      7056        1375        1761\n75103        1619               4287     10160        2085        2617\n75104        1247               4100      7793        1863        2344\n75105        1869              11010     15853        2611        3494\n75106        1788               8296     10170        1842        2348\n75107        2462               8257     12641        2165        3603\n75108        1801               5559      9702        1565        2846\n75109        2736               7069     19617        3478        4083\n75110        2792              11091     24147        6343        6956\n75111        4078              16834     41433        9858       11984\n75112        3110              17818     34751        8065       12084\n75113        3579              26830     37734       12013       18004\n75114        2833              21803     34451        7799       10691\n75115        5406              33083     61908       11934       18334\n75116        7610              29263     38068        7483       12469\n75117        5507              22483     44533       10295       13820\n75118        5173              26132     43799       13748       19650\n75119        4114              27105     31834       15607       19879\n75120        4372              26471     36741       15451       20449\n92002        1174               7550     14133        2770        5006\n92004        2182              10945     17202        5226        9078\n92007         620               5612      3976        3216        6011\n92009         718               3611      6113        1448        2530\n92012        4082              14403     31656        6128        9720\n92014         328               2936      5186         917        1514\n92019         719               4553      5407        2008        3674\n92020         746               4061      8280        1817        3388\n92022         452               2383      4802         911        1917\n92023        1429               6146      8927        2801        5615\n92024        1202               8388      9841        4630        8015\n92025        2156              12208     12715        5698        9687\n92026        1917               9884     20200        4001        7523\n92032         473               3343      4078        1437        2795\n92033         603               2344      3653         806        1422\n92035         771               3110      6950        1335        2677\n92036         877               7739      2661        4435        6531\n92040        1461               7523     18169        3145        6084\n92044        2105               7096     16792        3331        5410\n92046         568               4306      4989        2052        3797\n92048        1105               5766      8714        2228        4372\n92049         993               5656     11614        2579        4552\n92050        1797              15107     12152        7347       13245\n92051        3093               9177     14478        2648        3784\n92060         509               2970      5771        1226        3231\n92062        1168               5086     11122        2606        4376\n92063        1922               9678     16483        3814        6784\n92064         943               4300      7694        1193        2038\n92071         570               3250      4443         803        1334\n92072         619               2753      5159        1235        2021\n92073        1387               5396     11825        2697        4597\n92075         556               3638      6112        1327        2490\n92076         315               1278      2005         326         490\n92077         268               1566      2465         516         983\n92078         383               4246      1193        2004        3386\n93001        1803              17959      4105        9383       11997\n93005        1825              15462      4347        7498       10384\n93006        1022               5861      3453        2925        4564\n93007        1440              10074      1672        5329        7692\n93008         848              12230      1748        4859        7083\n93010        1186               9569      2401        5114        7288\n93013         380               2417       867        1431        2054\n93014         543               7058       510        2174        3285\n93027        1120               8740      1114        5351        5998\n93029        1908              11751      2701        6932        9906\n93030         152               2004       267        1131        1797\n93031        1006               9637      2592        4599        7650\n93032         883               5250      3412        2649        4994\n93033         180                767      1011         254         667\n93039         122               1355       487         899        1163\n93045         612               2847      3727        1636        2376\n93046        1160               6211      2972        2863        6218\n93047         767               5104      1314        1753        3309\n93048        2424              15246     14691       10062       12278\n93049         608               2444      2933        1224        2525\n93050         665               5486      2203        1982        5805\n93051        1302               9093      7571        4600        8793\n93053         936               7492      2444        3703        6353\n93055        1238               8681      6417        5087        7251\n93057         800               3106      1809        1660        3000\n93059         613               6152      1068        2952        3882\n93061         375               2442      2000        1540        2191\n93062         555               1736      2259         866        1464\n93063         738               4446      2665        2501        3806\n93064         881               6249      3846        3168        6608\n93066        2005              21474      7505       12089       14386\n93070        1149               7621      6161        4841        6377\n93071         936               9139      1751        4729        6760\n93072         805               7476       720        3668        5365\n93073         827               5122      1798        2717        4866\n93074         107                880       424         598         934\n93077         746               4007      3278        1760        3726\n93078         755               6756      1565        3262        5000\n93079         236               2539       309        1375        1997\n94002        1005               6028      5570        3645        5546\n94003         414               3280      3418        1423        2431\n94004         345               2708      1100        1248        2679\n94011         357               2921       794        1580        2722\n94015         470               2136      3191         796        1605\n94016         462               5823      5204        2027        3114\n94017        1808              11605      5828        5328       10405\n94018         836               3466      6067        1476        2778\n94019         485               2375      1425        1211        2387\n94021         408               2918      1558        1027        3008\n94022        1093               6190      4200        3716        6008\n94028        1904              14270      8361        6566       13682\n94033        1139               6421      7810        3394        5843\n94034         415               5565      2788        1388        3981\n94037         397               2797      2585        1432        2351\n94038         593               4300      3990        1932        3772\n94041        1319              10507      7337        5137        7976\n94042         613               2462      3262        1125        2077\n94043         440               3983      4120        1805        3168\n94044         583               3810      1982        1534        3940\n94046        1110               6855      9212        2954        7050\n94048         133                746       681         138         473\n94052         904               3854      7427        1620        2835\n94054         451               3841      1140        1874        3482\n94055         502               1224      1114         411        1058\n94058         974               3563      6406        1597        2947\n94059         536               2172      1950         891        2616\n94060         286               1516       946         588        1805\n94065         112                514       856         262         681\n94067         818               2757      5174        1042        1628\n94068        2431               9265     14149        3056        6692\n94069         405               1803      2589         863        1551\n94071         723               3563      3412        1282        2869\n94073         659               3996      3347        1739        3891\n94074         291               2582       510        1338        2059\n94075         420               1220      1160         480        1305\n94076        1152               9404      5844        4115        6826\n94077         597               2809      1379        1442        2712\n94078         723               6285      1039        2878        5180\n94079         564               4122      3286        1307        3579\n94080        1262               5049     13875        2404        3642\n94081        2118              15797      6440        7232       12788\n      nb_Ouvriers nb_PI nb_Retraités\n75101         362  1607         2595\n75102         647  2566         2140\n75103         667  4174         4539\n75104         556  3277         4466\n75105         913  5239        10496\n75106         629  3112         8032\n75107         878  3791         9369\n75108         836  3053         5190\n75109        1344  6361         7146\n75110        2505 10028        10405\n75111        3767 18948        21357\n75112        3793 17066        24117\n75113        5903 20178        31715\n75114        2998 13834        24067\n75115        4839 23688        40711\n75116        3140 13014        30769\n75117        4405 17450        24274\n75118        8542 24062        25315\n75119        7795 20309        27746\n75120        7962 23883        30579\n92002        1848  6869        11748\n92004        3674 10134        11320\n92007        2576  4719         5645\n92009         985  3613         4308\n92012        2580 13269        19435\n92014         584  2153         3576\n92019        1623  4176         5314\n92020        1017  4789         5712\n92022         561  2489         3358\n92023        1972  6474         9507\n92024        3488  7692         7724\n92025        4440  9453        12087\n92026        1984  9647        12132\n92032         906  2830         4384\n92033         491  1830         3427\n92035         954  3854         4364\n92036        3712  4705         6784\n92040        1513  8107         9707\n92044        1552  7924         9662\n92046        1375  3882         4619\n92048        1758  4902         8338\n92049        1426  6118         7825\n92050        5485  9611        11663\n92051         763  4280        11434\n92060        1039  4089         5000\n92062        1488  5282         6019\n92063        2132  8942        13113\n92064         510  2685         4726\n92071         370  1803         3950\n92072         646  2406         4021\n92073        1459  5708         6232\n92075         741  3481         5087\n92076         156   737         1747\n92077         241  1211         1797\n92078        1840  2087         3347\n93001        9551  6303         7835\n93005        8102  7705        11094\n93006        2634  3738         4850\n93007        5791  4325         7310\n93008        5026  3716         5435\n93010        4683  4422         6933\n93013        1777  1345         2035\n93014        2697  1807         2648\n93027        4966  2694         4229\n93029        6568  6663         9818\n93030         970   881         1034\n93031        4709  4717         6576\n93032        2764  4816         6142\n93033         268  1025         1377\n93039         473   823          940\n93045        1010  2930         4059\n93046        3427  5642         7333\n93047        2289  2747         4014\n93048        6651 12739        15162\n93049        1122  2823         3332\n93050        2714  4214         4839\n93051        4089  8630         9452\n93053        3516  4024         5352\n93055        4665  6539         7049\n93057        1893  3014         3341\n93059        3254  2103         3275\n93061        1159  2070         2480\n93062         508  2070         2442\n93063        1912  3365         3664\n93064        3234  5435         6510\n93066        9844  9196        10940\n93070        3586  5473         4943\n93071        4817  4219         6529\n93072        3634  2606         4155\n93073        3187  4424         5243\n93074         588   970         1050\n93077        2004  3752         4823\n93078        3154  3435         4701\n93079        1122  1103         1549\n94002        2778  5590         6100\n94003        1127  2631         3046\n94004        1302  1742         2320\n94011        1575  1669         2536\n94015         601  2208         3110\n94016        1089  3230         4200\n94017        5696  8885        11280\n94018         800  4110         4882\n94019        1393  2060         3141\n94021        1494  2214         3109\n94022        3388  5711         5977\n94028        5278 10901        12880\n94033        2464  6177         8429\n94034        1496  3780         3676\n94037        1033  2392         2563\n94038        1687  3487         5734\n94041        4141  7194         8641\n94042         630  2435         3565\n94043        1064  2710         3333\n94044        2092  4106         2819\n94046        2366  7643         9925\n94048         232   505         1075\n94052         875  4031         6058\n94054        2176  2456         3092\n94055         599  1199         2468\n94058        1162  4553         6223\n94059        1302  2538         3869\n94060         882  1529         1665\n94065         247   966         1028\n94067         365  2635         4012\n94068        2324  9043        15911\n94069         391  1778         2263\n94071        1417  3182         5774\n94073        1996  3999         5380\n94074        1471  1272         1695\n94075         765  1550         2325\n94076        2877  6417         8768\n94077        2154  2355         3489\n94078        3833  2649         3910\n94079        2009  3520         5204\n94080        1129  6119         7759\n94081        8175  9459        13396\n```\n\n\n:::\n:::\n\n\n## La méthode de la CAH appliquée à nos données\n\n### Constitution des classes\n\n```{=html}\n<!-- On reprend les étapes de la méthode décrite <a href=\"https://camille-sisi.github.io/Data-Mining-2022/14-Clustering-theorique.html\" target=\"_blank\">ici</a>, une par une. -->\n```\n\nComme nos communes ont plus d'habitants que d'autres, pour éviter un effet taille de nos communes, on va utiliser la distance du khi-2. Pour cela, deux façons de faire avec deux packages différents : soit le package **`vegan()`** et la fonction `decostand()` avec l'argument `method=\"chi.square\"` qui crée un tableau sur lequel on applique ensuite la méthode de distance euclidienne et dans ce cas on aura des distinces similaires à celles du khi-2 (voir [ici](https://pmarchand1.github.io/ECL7102/notes_cours/14-Analyses_multivariees_Partie2.html#mesures_de_distance_pour_les_abondances%5D)) ; soit le package **`ade4`** et les fonctions combinées `dist.dudi(dudi.coa())` avec l'argument `amongrow=TRUE` (pour préciser que les distances doivent être calculées entre lignes, ici les communes).\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Etape 1 : on transforme la table sur laquelle on obtiendra des distances du khi-deux\n# install.packages(\"vegan\")\nlibrary(vegan)\ncat_soc_chi2 <- decostand(cat_soc, method = \"chi.square\")\n\n# Etape 2 : on crée la matrice de distance, en utilisant la distance euclidienne \n# standard sur la table transformée, ce qui nous donnera des distances similaires \n# à celle du khi-2\ndist_mat <- dist(cat_soc_chi2, method = 'euclidean')\n\n# on peut vérifier qu'on obtient la même matrice avec la seconde méthode évoquée\n# install.packages(\"ade4\")\nlibrary(ade4)\ndist_mat_bis <- dist.dudi(dudi.coa(cat_soc, scannf=FALSE, nf=7), amongrow=TRUE)\n\n# si on souhaite voir et comparer les matrices de distances, \n# on doit les transformer en matrice avec la fonction 'as.matrix' :\ncat_soc_chi2_m <- as.matrix(dist_mat)\ncat_soc_chi2_bis_m <- as.matrix(dist_mat_bis)\n# elles sont bien similaires -> on peut supprimer de l'environnement la seconde\nrm(cat_soc_chi2_bis_m)\n\n\n#Etape 3 : on choisit la méthode d'agrégation, ici la plus standard, le critère de Ward\nclassif_socioprof <- hclust(dist_mat, method = \"ward.D2\")\n\n\n#Etape 4 : on visualise l'arbre de classification ou dendogramme\nplot(classif_socioprof, xlab=\"Commune\",  main=\"Dendogramme\")\n```\n\n::: {.cell-output-display}\n![](12-Clustering-application_files/figure-html/Etapes_CAH-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# plot(classif_socioprof, xlab=\"Commune\",  main=\"Dendogramme\", labels=FALSE)\n```\n:::\n\n\nOn remarque ici que comme nous avons mis en label le nom des communes, on peut tout de suite savoir quelles communes sont proches et vont former des classes. Toutefois, avec 136 communes ce n'est absolument pas lisible !! Donc on peut aussi les enlever avec l'option `label=FALSE` dans la fonction `plot()`.\\\nIl existe aussi une fonction *via* **`ggplot2`** pour dessiner l'abre, mais il faut installer avant le package **`ggdendro`**.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggdendro)\nggdendrogram(classif_socioprof, labels=FALSE)\n```\n\n::: {.cell-output-display}\n![](12-Clustering-application_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n\nIl faut maintenant prendre une décision : où coupe-t-on l'arbre pour obtenir une partition de la population (ici nos communes), autrement dit combien de classes choisissons-nous ?\\\nOn peut d'abord s'appuyer sur la forme du dendogramme : plus une \"branche\" est haute et plus on perd en distance ou ici (critère de Ward) en inertie intraclasse[^12-clustering-application-1], il faudra donc couper l'arbre au niveau de cette branche. Il faut également prendre en compte ce qui peut être le mieux pour l'analyse : si on aboutit à une classification en 2 classes, cela risque d'être peu intéressant à analyser, mais si on a une classification en 5 classes ou plus, cela va devenir compliqué à interpréter...\\\nIci, dans les deux cas, il semble que choisir 2 classes soit très pertinent, mais on voit qu'on pourrait aussi choisir 4 classes (ou même 3 éventuellement) si l'on veut rentrer un peu plus dans le détail de l'analyse.\n\n[^12-clustering-application-1]: Plus précisément, à chaque étape d'agrégation, la part de l'inertie interclasse passe en inertie intraclasse.\n\nOn peut également s'aider de représentations des sauts d'inertie du dendrogramme selon le nombre de classes qui peut être retenu, avec la fonction plot et en récupérant l'information sur l'inertie (`height`).\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# On stocke l'attribut `$height` dans l'objet `inertie` en triant les valeurs par \n# ordre décroissant.\ninertie_socioprof <- sort(classif_socioprof$height, decreasing=TRUE)\nplot(inertie_socioprof, type=\"s\", xlab=\"Nombre de classes\", ylab=\"Inertie\", \n     xlim = c(1,15), xaxp = c(1,15,14))\npoints(c(2, 3, 4), inertie_socioprof[c(2,3,4)], \n       col = c(\"blue3\", \"brown3\", \"chartreuse3\"), cex = 2, lwd = 2)\n```\n\n::: {.cell-output-display}\n![](12-Clustering-application_files/figure-html/Plot_inertie-1.png){width=672}\n:::\n:::\n\n\nOu encore créer d'autres indicateurs plus rigoureux, comme la part de la perte d'inertie interclasse dans l'inertie totale (on parle aussi de \"semi-partial R-squared\").\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#on crée un indicateur de part en %\npartinertie_socioprof <- inertie_socioprof/sum(inertie_socioprof)*100\nplot(partinertie_socioprof, type=\"b\", xlab=\"Nombre de classes\", \n     ylab=\"Part dans l'inertie totale en %\", xlim = c(1,15), xaxp = c(1,15,14))\n```\n\n::: {.cell-output-display}\n![](12-Clustering-application_files/figure-html/Plot_inertie_bis-1.png){width=672}\n:::\n:::\n\n\nOn voit que les graphiques sont assez proches, qu'ils soient construits à partir de la mesure en valeur absolue ou en valeur relative. Il y a un saut important après 2 classes (hauteur sur le 1er graphique, ou importance de la pente sur le 2ème graphique) par exemple.\n\nEnfin, à savoir que des fonctions existent donnant une indication de la \"meilleure\" partition à choisir, mais attention le choix se fait aussi (et peut-être surtout) en fonction de l'analyse que l'on veut mener et de l'interprétation que l'on pourra faire des classes obtenues ! Pour l'exemple, je vous mets ci-dessous le code de Julien Larmarange pour tester ce type de fonctions ; la \"meilleure\" partition selon la perte d'inertie relative est représentée par un point noir et la seconde par un point gris. On voit qu'ici il est bien indiqué d'abord 2 classes, puis comme seconde \"meilleure\" partition 3 classes, ce qui correspond plutôt bien aux graphiques précédents.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(devtools)\nsource(url(\"https://raw.githubusercontent.com/larmarange/JLutils/master/R/clustering.R\"))\n#On a choisit un maximum de 15 classes ici...\nbest.cutree(classif_socioprof, min=2, max=15, graph = TRUE, \n            xlab = \"Nombre de classes\", ylab = \"Inertie relative\")\n```\n\n::: {.cell-output-display}\n![](12-Clustering-application_files/figure-html/Best_cutree-1.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 2\n```\n\n\n:::\n:::\n\n\nFinalement, au vu de la forme du dendogramme et des graphes sur l'inertie (et de la fonction d'aide à la décision précédente), on choisit de prendre 4 classes pour une analyse plus fine, mais on va stocker également les résultats pour 3 classes. On peut de nouveau visualiser le dendogramme en matérialisant les différents choix du nombre de classes.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mfrow = c(1, 1), mar=c(5, 9, 1, 1))\nplot(classif_socioprof, xlab=\"Commune\",  main=\"Dendogramme\", label=FALSE)\nrect.hclust(classif_socioprof, k=3, border = 'blue3')\nrect.hclust(classif_socioprof, k=4, border = 'brown3')\n```\n\n::: {.cell-output-display}\n![](12-Clustering-application_files/figure-html/Choix_cut-1.png){width=672}\n:::\n:::\n\n\nOn peut également utiliser la fonction `color_branches()` du package `dendextend()`, mais il faut appeler de nouveau `ggplot2` après.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# On peut encore également utiliser la fonction `color_branches()` du package \n# `dendextend()` mais il faut appeler de nouveau `ggplot2` après\nlibrary(dendextend)\nlibrary(ggplot2)\nggplot(color_branches(classif_socioprof, k = 4), labels = FALSE)\n```\n\n::: {.cell-output-display}\n![](12-Clustering-application_files/figure-html/dendogramme coloré-1.png){width=672}\n:::\n:::\n\n\nOn choisit donc d'abord d'analyser notre clustering en 3 ou 4 classes : pour découper l'arbre et obtenir la partition souhaitée, on utilise la fonction `cutree()`, et on peut ensuite visualiser quelle commune est dans quelle classe et le nombre (et la part) de communes par classe.\\\nOn intègre ensuite la variable au tableau initial \"cat_soc_chi2\" qui contient les variables utilisées, mais on pourra ensuite fusionner la table avec notre table initiale \"RP_final\" pour mener des analyses plus approfondies des classes, y compris avec des variables non utilisées dans le clustering.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Découpage en k classes\nclasse3_socioprof <- cutree(classif_socioprof, k=3)\nclasse4_socioprof <- cutree(classif_socioprof, k=4)\n\n#Liste des groupes\n#library(janitor)\ntabyl(classe3_socioprof) %>% adorn_pct_formatting() %>% gt()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"qsqizzbqja\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#qsqizzbqja table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#qsqizzbqja thead, #qsqizzbqja tbody, #qsqizzbqja tfoot, #qsqizzbqja tr, #qsqizzbqja td, #qsqizzbqja th {\n  border-style: none;\n}\n\n#qsqizzbqja p {\n  margin: 0;\n  padding: 0;\n}\n\n#qsqizzbqja .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#qsqizzbqja .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#qsqizzbqja .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#qsqizzbqja .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#qsqizzbqja .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#qsqizzbqja .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#qsqizzbqja .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#qsqizzbqja .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#qsqizzbqja .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#qsqizzbqja .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#qsqizzbqja .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#qsqizzbqja .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#qsqizzbqja .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#qsqizzbqja .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#qsqizzbqja .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#qsqizzbqja .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#qsqizzbqja .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#qsqizzbqja .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#qsqizzbqja .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#qsqizzbqja .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#qsqizzbqja .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#qsqizzbqja .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#qsqizzbqja .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#qsqizzbqja .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#qsqizzbqja .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#qsqizzbqja .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#qsqizzbqja .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#qsqizzbqja .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#qsqizzbqja .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#qsqizzbqja .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#qsqizzbqja .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#qsqizzbqja .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#qsqizzbqja .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#qsqizzbqja .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#qsqizzbqja .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#qsqizzbqja .gt_left {\n  text-align: left;\n}\n\n#qsqizzbqja .gt_center {\n  text-align: center;\n}\n\n#qsqizzbqja .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#qsqizzbqja .gt_font_normal {\n  font-weight: normal;\n}\n\n#qsqizzbqja .gt_font_bold {\n  font-weight: bold;\n}\n\n#qsqizzbqja .gt_font_italic {\n  font-style: italic;\n}\n\n#qsqizzbqja .gt_super {\n  font-size: 65%;\n}\n\n#qsqizzbqja .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#qsqizzbqja .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#qsqizzbqja .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#qsqizzbqja .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#qsqizzbqja .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#qsqizzbqja .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#qsqizzbqja .gt_indent_5 {\n  text-indent: 25px;\n}\n\n#qsqizzbqja .katex-display {\n  display: inline-flex !important;\n  margin-bottom: 0.75em !important;\n}\n\n#qsqizzbqja div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {\n  height: 0px !important;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"classe3_socioprof\">classe3_socioprof</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"n\">n</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"percent\">percent</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"classe3_socioprof\" class=\"gt_row gt_right\">1</td>\n<td headers=\"n\" class=\"gt_row gt_right\">39</td>\n<td headers=\"percent\" class=\"gt_row gt_right\">28.7%</td></tr>\n    <tr><td headers=\"classe3_socioprof\" class=\"gt_row gt_right\">2</td>\n<td headers=\"n\" class=\"gt_row gt_right\">41</td>\n<td headers=\"percent\" class=\"gt_row gt_right\">30.1%</td></tr>\n    <tr><td headers=\"classe3_socioprof\" class=\"gt_row gt_right\">3</td>\n<td headers=\"n\" class=\"gt_row gt_right\">56</td>\n<td headers=\"percent\" class=\"gt_row gt_right\">41.2%</td></tr>\n  </tbody>\n  \n</table>\n</div>\n```\n\n:::\n\n```{.r .cell-code}\ntabyl(classe4_socioprof) %>% adorn_pct_formatting() %>% gt()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"yskaholivj\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#yskaholivj table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#yskaholivj thead, #yskaholivj tbody, #yskaholivj tfoot, #yskaholivj tr, #yskaholivj td, #yskaholivj th {\n  border-style: none;\n}\n\n#yskaholivj p {\n  margin: 0;\n  padding: 0;\n}\n\n#yskaholivj .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#yskaholivj .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#yskaholivj .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#yskaholivj .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#yskaholivj .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#yskaholivj .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#yskaholivj .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#yskaholivj .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#yskaholivj .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#yskaholivj .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#yskaholivj .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#yskaholivj .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#yskaholivj .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#yskaholivj .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#yskaholivj .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#yskaholivj .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#yskaholivj .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#yskaholivj .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#yskaholivj .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#yskaholivj .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#yskaholivj .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#yskaholivj .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#yskaholivj .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#yskaholivj .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#yskaholivj .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#yskaholivj .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#yskaholivj .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#yskaholivj .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#yskaholivj .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#yskaholivj .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#yskaholivj .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#yskaholivj .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#yskaholivj .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#yskaholivj .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#yskaholivj .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#yskaholivj .gt_left {\n  text-align: left;\n}\n\n#yskaholivj .gt_center {\n  text-align: center;\n}\n\n#yskaholivj .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#yskaholivj .gt_font_normal {\n  font-weight: normal;\n}\n\n#yskaholivj .gt_font_bold {\n  font-weight: bold;\n}\n\n#yskaholivj .gt_font_italic {\n  font-style: italic;\n}\n\n#yskaholivj .gt_super {\n  font-size: 65%;\n}\n\n#yskaholivj .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#yskaholivj .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#yskaholivj .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#yskaholivj .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#yskaholivj .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#yskaholivj .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#yskaholivj .gt_indent_5 {\n  text-indent: 25px;\n}\n\n#yskaholivj .katex-display {\n  display: inline-flex !important;\n  margin-bottom: 0.75em !important;\n}\n\n#yskaholivj div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {\n  height: 0px !important;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"classe4_socioprof\">classe4_socioprof</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"n\">n</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"percent\">percent</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"classe4_socioprof\" class=\"gt_row gt_right\">1</td>\n<td headers=\"n\" class=\"gt_row gt_right\">39</td>\n<td headers=\"percent\" class=\"gt_row gt_right\">28.7%</td></tr>\n    <tr><td headers=\"classe4_socioprof\" class=\"gt_row gt_right\">2</td>\n<td headers=\"n\" class=\"gt_row gt_right\">41</td>\n<td headers=\"percent\" class=\"gt_row gt_right\">30.1%</td></tr>\n    <tr><td headers=\"classe4_socioprof\" class=\"gt_row gt_right\">3</td>\n<td headers=\"n\" class=\"gt_row gt_right\">28</td>\n<td headers=\"percent\" class=\"gt_row gt_right\">20.6%</td></tr>\n    <tr><td headers=\"classe4_socioprof\" class=\"gt_row gt_right\">4</td>\n<td headers=\"n\" class=\"gt_row gt_right\">28</td>\n<td headers=\"percent\" class=\"gt_row gt_right\">20.6%</td></tr>\n  </tbody>\n  \n</table>\n</div>\n```\n\n:::\n\n```{.r .cell-code}\nsort(classe4_socioprof) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n75101 75102 75103 75104 75105 75106 75107 75108 75109 75110 75111 75112 75114 \n    1     1     1     1     1     1     1     1     1     1     1     1     1 \n75115 75116 75117 92002 92012 92014 92020 92022 92026 92035 92040 92044 92049 \n    1     1     1     1     1     1     1     1     1     1     1     1     1 \n92051 92062 92063 92064 92071 92072 92073 92075 92076 92077 94052 94067 94080 \n    1     1     1     1     1     1     1     1     1     1     1     1     1 \n75113 75118 75119 75120 92004 92009 92019 92023 92024 92025 92032 92033 92046 \n    2     2     2     2     2     2     2     2     2     2     2     2     2 \n92048 92060 93033 93045 93049 93062 93077 94003 94015 94016 94018 94033 94037 \n    2     2     2     2     2     2     2     2     2     2     2     2     2 \n94038 94042 94043 94046 94048 94055 94058 94059 94065 94068 94069 94071 94073 \n    2     2     2     2     2     2     2     2     2     2     2     2     2 \n94075 94079 92007 92050 93006 93032 93046 93048 93050 93051 93055 93057 93061 \n    2     2     3     3     3     3     3     3     3     3     3     3     3 \n93063 93064 93070 93073 93074 94002 94017 94019 94021 94022 94028 94034 94041 \n    3     3     3     3     3     3     3     3     3     3     3     3     3 \n94044 94060 94076 94077 92036 92078 93001 93005 93007 93008 93010 93013 93014 \n    3     3     3     3     4     4     4     4     4     4     4     4     4 \n93027 93029 93030 93031 93039 93047 93053 93059 93066 93071 93072 93078 93079 \n    4     4     4     4     4     4     4     4     4     4     4     4     4 \n94004 94011 94054 94074 94078 94081 \n    4     4     4     4     4     4 \n```\n\n\n:::\n\n```{.r .cell-code}\n#Ajout des variables de classe dans la table initiale de clustering : on ne crée qu'une\n# seule table qui aura nos 2 variables de typo selon 3 ou 4 classes\nclust_socioprof <- cbind.data.frame(cat_soc_chi2, classe3_socioprof=as.factor(classe3_socioprof))\nclust_socioprof <- cbind.data.frame(clust_socioprof, classe4_socioprof=as.factor(classe4_socioprof))\n```\n:::\n\n\nLa 1ère classe comprend donc 39 communes soit 29% de l'ensemble des communes de Paris et sa petite couronne, la 2ème classe 41 communes ou 30%, et la 3ème classe rassemble 56 communes soit 41% lorsqu'elle est agrégée et sinon se divive en deux classes de même nombre (28 et 28) ou proportion dans la partition à 4 classes. La dernière sortie nous donne la place de chaque commune dans chacune des 4 classes, mais ce n'est pas super lisible comme cela.\n\n### Visualisation sur la carte des communes et départements\n\nEnfin, on peut visualiser sur la carte des communes et départements les quatre classes construites et choisies.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#library(geojsonsf)\nlibrary(sf)\nlibrary(mapsf)\n\n# on charge le fonds de carte des communes -> vous pouvez reprendre les tables utilisées dans le cours de Claude Grasland, sinon la télécharger sur opendatasoft\n# map_com <- geojson_sf(\"https://public.opendatasoft.com/api/explore/v2.1/catalog/datasets/geoflar-communes-2015/exports/geojson?lang=fr&refine=nom_reg%3A%22ILE-DE-FRANCE%22&timezone=Europe%2FBerlin\")\nmap_com <- readRDS(\"data/map_com.RDS\")\nmap_com <- map_com %>% \n  rename(COM=com_code) %>% \n  mutate(COM=as.character(COM))\nmap_dept <- map_com %>% group_by(dep_code, dep_name) %>% \n                  summarise()\n# si ajout contours établissements publics territoriaux (EPT)\n# map_ept <- readRDS(\"data/map_ept.RDS\")\n\ntypo3 <- clust_socioprof %>% rownames_to_column(var = \"COM\") %>% \n  select(COM, classe3_socioprof)\nmap_com_typo3 <- map_com %>% select(COM, com_name, geometry) %>% \n  left_join(typo3)\nmf_theme(\"agolalight\")\nmf_map(map_com_typo3, var=\"classe3_socioprof\", type=\"typo\", \n       pal = c(\"aquamarine3\", \"coral\", \"skyblue3\"),\n       leg_pos = \"bottomleft\", leg_title=\"Cluster\",\n       col_na = \"gray80\", leg_no_data = \"Données manquantes\")\nmf_map(map_dept, var=\"nom_dep\",  type = \"base\",\n       col = NA, col_na = \"gray80\",\n       border=\"black\",lwd=1, add = TRUE)\nmf_layout(title = \"Profils PCS des communes de Paris et sa petite couronne\",\n          frame = TRUE, credits=\" \", arrow = F)\n```\n\n::: {.cell-output-display}\n![](12-Clustering-application_files/figure-html/carto_clust-1.png){width=672}\n:::\n\n```{.r .cell-code}\ntypo4 <- clust_socioprof %>% rownames_to_column(var = \"COM\") %>% \n  select(COM, classe4_socioprof)\nmap_com_typo4 <- map_com %>% select(COM, com_name, geometry) %>% \n  left_join(typo4)\nmf_theme(\"agolalight\")\nmf_map(map_com_typo4, var=\"classe4_socioprof\", type=\"typo\", \n       pal = c(\"aquamarine3\", \"coral\", \"skyblue3\", \"brown4\"),\n       leg_pos = \"bottomleft\", leg_title=\"Cluster\",\n       col_na = \"gray80\", leg_no_data = \"Données manquantes\")\n# mf_map(map_ept, var=\"ept_name\",  type = \"base\",\n#        col = NA, col_na = \"gray80\",\n#        border=\"blue\",lwd=1, add = TRUE)\nmf_map(map_dept, var=\"nom_dep\",  type = \"base\",\n       col = NA, col_na = \"gray80\",\n       border=\"black\",lwd=1, add = TRUE)\nmf_layout(title = \"Profils PCS des communes de Paris et sa petite couronne\",\n          frame = TRUE, credits=\" \", arrow = F)\n```\n\n::: {.cell-output-display}\n![](12-Clustering-application_files/figure-html/carto_clust-2.png){width=672}\n:::\n:::\n\n\nOn voit avec la seconde carte que la partition en 4 classes permet de préciser le clustering en particulier pour les communes du département de Seine-St-Denis. On va retenir définitivement cette partition en 4 classes pour l'interprétation.\n\n### Interprétation\n\nIl faut maintenant comprendre la partition obtenue et interpréter nos 4 classes en les décrivant principalement ici à partir des variables utilisées dans le clustering. On peut pour cela utiliser le package **`FactoMineR`** qui permet avec la fonction `catdes` de sortir des résultats sur, d'une part, les liens les plus significatifs entre les variables actives de la CAH et la variable globale de cluster/classes, et, d'autre part de manière plus précise, sur les liens les plus significatifs entre les variables et chacune des classes. De manière générale, le package **`FactoMineR`** est presque indispensable pour toute analyse factorielle de données et/ou clustering (voir [ici](https://larmarange.github.io/guide-R/analyses_avancees/analyse-factorielle.html)).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(FactoMineR)\n# on retire la variable de classe qui ne nous intéresse pas (la type en 3 classes ici)\ncatdes(clust_socioprof[, -9], num.var = 9)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nLink between the cluster variable and the quantitative variables\n================================================================\n                        Eta2      P-value\nnb_Cadres          0.9075190 5.051344e-68\nnb_Ouvriers        0.8691562 4.369492e-58\nnb_Employés        0.8304926 1.125821e-50\nnb_Chômeurs        0.7194329 2.916476e-36\nnb_Autres.inactifs 0.6262392 4.530630e-28\nnb_PI              0.4836017 7.367933e-19\nnb_Retraités       0.3360390 9.898185e-12\nnb_Arti_com        0.2180956 3.920464e-07\n\nDescription of each cluster by quantitative variables\n=====================================================\n$`1`\n                      v.test Mean in category Overall mean sd in category\nnb_Cadres           9.230631        0.6634648    0.3984220     0.05880146\nnb_Arti_com         5.077079        0.2140143    0.1772711     0.06795860\nnb_PI              -2.306082        0.3535017    0.3736918     0.05635525\nnb_Autres.inactifs -4.054787        0.3745396    0.4253899     0.06096658\nnb_Chômeurs        -5.972422        0.2115313    0.2844051     0.03021788\nnb_Ouvriers        -8.016067        0.1146623    0.2744024     0.02567630\nnb_Employés        -8.936187        0.2633226    0.3842266     0.03755561\n                   Overall sd      p.value\nnb_Cadres          0.21154267 2.690426e-20\nnb_Arti_com        0.05331831 3.832822e-07\nnb_PI              0.06450243 2.110606e-02\nnb_Autres.inactifs 0.09239296 5.018006e-05\nnb_Chômeurs        0.08989471 2.337566e-09\nnb_Ouvriers        0.14681341 1.091849e-15\nnb_Employés        0.09967854 4.028297e-19\n\n$`2`\n                      v.test Mean in category Overall mean sd in category\nnb_Retraités        5.082473        0.4869929    0.4357343     0.07511809\nnb_PI               4.885737        0.4149784    0.3736918     0.04466321\nnb_Ouvriers        -2.682174        0.2228135    0.2744024     0.05872551\nnb_Chômeurs        -3.677228        0.2410982    0.2844051     0.05158555\nnb_Autres.inactifs -4.130110        0.3753976    0.4253899     0.04916426\n                   Overall sd      p.value\nnb_Retraités       0.07698186 3.725522e-07\nnb_PI              0.06450243 1.030429e-06\nnb_Ouvriers        0.14681341 7.314544e-03\nnb_Chômeurs        0.08989471 2.357823e-04\nnb_Autres.inactifs 0.09239296 3.625898e-05\n\n$`3`\n               v.test Mean in category Overall mean sd in category Overall sd\nnb_Employés  4.935740        0.4673877    0.3842266     0.04304196 0.09967854\nnb_PI        3.618256        0.4131413    0.3736918     0.03912118 0.06450243\nnb_Ouvriers  3.596816        0.3636609    0.2744024     0.05800568 0.14681341\nnb_Chômeurs  2.306199        0.3194478    0.2844051     0.05270552 0.08989471\nnb_Arti_com -2.107284        0.1582793    0.1772711     0.02962413 0.05331831\nnb_Cadres   -4.040794        0.2539344    0.3984220     0.05845409 0.21154267\n                 p.value\nnb_Employés 7.984729e-07\nnb_PI       2.965946e-04\nnb_Ouvriers 3.221364e-04\nnb_Chômeurs 2.109949e-02\nnb_Arti_com 3.509293e-02\nnb_Cadres   5.327051e-05\n\n$`4`\n                      v.test Mean in category Overall mean sd in category\nnb_Autres.inactifs  8.744175        0.5619500    0.4253899     0.07117056\nnb_Chômeurs         8.547157        0.4142790    0.2844051     0.05537340\nnb_Ouvriers         8.413011        0.4831796    0.2744024     0.06607172\nnb_Employés         6.594694        0.4953390    0.3842266     0.03801306\nnb_Arti_com        -3.049291        0.1497896    0.1772711     0.02382982\nnb_Retraités       -5.374273        0.3658026    0.4357343     0.04702790\nnb_PI              -6.583845        0.3019088    0.3736918     0.03950428\nnb_Cadres          -7.743861        0.1215229    0.3984220     0.03903016\n                   Overall sd      p.value\nnb_Autres.inactifs 0.09239296 2.246510e-18\nnb_Chômeurs        0.08989471 1.261573e-17\nnb_Ouvriers        0.14681341 3.996168e-17\nnb_Employés        0.09967854 4.261338e-11\nnb_Arti_com        0.05331831 2.293824e-03\nnb_Retraités       0.07698186 7.689216e-08\nnb_PI              0.06450243 4.584360e-11\nnb_Cadres          0.21154267 9.644260e-15\n```\n\n\n:::\n:::\n\n\nOn peut voir que la 1ère classe est marquée par une surreprésentation du nombre de personnes (de référence du ménage) cadres, puis artisans-commerçants ; et au contraire, une sous-représentation des employés, ouvriers, chômeurs ou encore autres inactifs. Sur la carte, on avait vu que cette classe était présente dans 16 des 20 arrondissements de Paris, ainsi que dans des communes des Hauts-de-Seine. C'est donc la classe correspond aux communes des catégories d'actifs en emploi plutôt favorisées.\\\n  La seconde classe est, elle, caractérisée par une surreprésentation du nombre de retraités et de professions intermédiaires, et par une sous-représentation du nombte d'autres inactifs, chômeurs et ouvriers. Géographiquement, on avait vu qu'elle correspondait aux 4 autres arrondissements de Paris et à des communes disséminées surtout dans les Hauts-de-Seine et le Val-de-Marne. Cette classe pourraient correspondre à des classes moyennes supérieures soient en emploi (professions intermédiaires) soient à la retraite.\\\n  Dans la troisième classe, on note une surreprésentation des employés, des professions intermédiaires, des ouvriers et des chômeurs, et au contraire une sous-représentation des cadres et artisans-commerçants. Elle semble ainsi à l'opposé de la 1ère classe. Elle est davantage présente dans les communes du Val-de-Marne et de la Seine-Saint-Denis. Cette troisième classe correspond probablement ainsi à des catégories sociales moyennes basses, voire à des défavorisées.   Enfin, la quatrième classe se caractérise par une surreprésentation des autres inactifs, des chômeurs, des ouvriers et des employés. Elle se retrouve plutôt dans les communes de la Seine-Saint-Denis, et un peu dans le Val-de-Marne. Elle correspondrait alors aux catégories sociales les plus défavorisées.\n\nOn peut recupérer les statistiques de la moyenne de ces variables pour les visualiser sur un graphique comparant les 3 classes, ainsi que l'ensemble des communes, on va plutôt le faire à partir des variables centrées réduites, ce qui permet une une comparaison directe des profils de classe à partir de variables dont l’ordre de grandeur (l’écart-type) peut être différent.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# La fonction `scale()` permet de normaliser par colonne les valeurs numériques\nclust_socioprof_sc <- as.data.frame(scale(clust_socioprof[, -c(9, 10)])) \nclust_socioprof_1 <- cbind.data.frame(clust_socioprof_sc, \n                                      classe=as.factor(classe4_socioprof))\n\nmean_var <- clust_socioprof_1 %>% group_by(classe) %>% \n    summarise_all(list(mean))\n\nmean_var %>% pivot_longer(cols=-classe, names_to=\"Variable\", values_to=\"Value\") %>% \n  ggplot() + aes(x=Variable, y=Value, fill=classe) + geom_bar(stat=\"identity\") +\n  facet_wrap(~classe) +  scale_fill_brewer(palette = \"Set2\") +\n  theme_grey() + coord_flip() +\n  labs(title = \"Moyenne des variables actives selon les classes\",\n       x=\"Variables\", y=\"\") +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](12-Clustering-application_files/figure-html/Compar_mean_bis-1.png){width=672}\n:::\n:::\n\n\nCela nous dit la même chose que la description précédente mais dans un format plus visuelle.\n\nPour aller plus loin dans la compréhension des classes, il faut utiliser d'autres variables et procéder de même à des analyses descriptives croisant ces variables avec les 4 classes de la typologie obtenue. Pour cela, il faut récupérer des variables de la table initiale du RP et sortir des tableaux de statistiques ou des graphiques comme précédemment. <!--On peut aussi construire d'autres graphiques plus généraux et sur d'autres variables.-->\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Pour d'autres variables, tableau croisé en pourcentage à partir d'une nouvelle\n# fonction\nTabcr_pctcol <- function(data, var1, var2, pond=IPONDI, nom_var1=\"classe\"){\n  tabcroisefin <- data %>% group_by({{var2}})  %>% \n    count({{var1}}, wt={{pond}}) %>% pivot_wider(names_from = {{var1}},\n                                                 values_from = \"n\", \n                                                 names_prefix = paste0(nom_var1,\"_\")) %>% \n    adorn_totals(c(\"row\",'col')) %>% adorn_percentages(\"col\") %>% \n    adorn_pct_formatting(digits=2) \n  \n  return(tabcroisefin)\n}\n\nclust_socioprof <- clust_socioprof %>% rownames_to_column(var=\"COM\")\n\n# Liste variable à étudier plus en détails par exemple: \"HLML\",\"AGER20\", \"DIPL\", IMMI,\n# \"EMPL\", \"RECH\",  \"STAT_CONJ\", \"STOCD\",  \"TACTD16\", \"TP\",  \"TYPL\", \"ETUD\", SURF, CATL\nclust_socioprof %>% left_join(RP_final[RP_final$CS1!=\"1\" & \n                                         RP_final$COM!=\"ZZZZZ\" & \n                                         !RP_final$AGER20 %in% c(\"2\",\"5\",\"10\",\"14\"),\n                                       c(\"COM\", \"IPONDI\", \"DIPL\")],\n                                   by=\"COM\") %>% \n  libelles_var(cod_var=\"DIPL\", new_var = Diplome_nom) %>%  \n  Tabcr_pctcol(var1=classe4_socioprof, var2=Diplome_nom) %>% gt()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"joztsqrcss\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#joztsqrcss table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#joztsqrcss thead, #joztsqrcss tbody, #joztsqrcss tfoot, #joztsqrcss tr, #joztsqrcss td, #joztsqrcss th {\n  border-style: none;\n}\n\n#joztsqrcss p {\n  margin: 0;\n  padding: 0;\n}\n\n#joztsqrcss .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#joztsqrcss .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#joztsqrcss .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#joztsqrcss .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#joztsqrcss .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#joztsqrcss .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#joztsqrcss .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#joztsqrcss .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#joztsqrcss .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#joztsqrcss .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#joztsqrcss .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#joztsqrcss .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#joztsqrcss .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#joztsqrcss .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#joztsqrcss .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#joztsqrcss .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#joztsqrcss .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#joztsqrcss .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#joztsqrcss .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#joztsqrcss .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#joztsqrcss .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#joztsqrcss .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#joztsqrcss .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#joztsqrcss .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#joztsqrcss .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#joztsqrcss .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#joztsqrcss .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#joztsqrcss .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#joztsqrcss .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#joztsqrcss .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#joztsqrcss .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#joztsqrcss .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#joztsqrcss .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#joztsqrcss .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#joztsqrcss .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#joztsqrcss .gt_left {\n  text-align: left;\n}\n\n#joztsqrcss .gt_center {\n  text-align: center;\n}\n\n#joztsqrcss .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#joztsqrcss .gt_font_normal {\n  font-weight: normal;\n}\n\n#joztsqrcss .gt_font_bold {\n  font-weight: bold;\n}\n\n#joztsqrcss .gt_font_italic {\n  font-style: italic;\n}\n\n#joztsqrcss .gt_super {\n  font-size: 65%;\n}\n\n#joztsqrcss .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#joztsqrcss .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#joztsqrcss .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#joztsqrcss .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#joztsqrcss .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#joztsqrcss .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#joztsqrcss .gt_indent_5 {\n  text-indent: 25px;\n}\n\n#joztsqrcss .katex-display {\n  display: inline-flex !important;\n  margin-bottom: 0.75em !important;\n}\n\n#joztsqrcss div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {\n  height: 0px !important;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"Diplome_nom\">Diplome_nom</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"classe_1\">classe_1</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"classe_2\">classe_2</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"classe_3\">classe_3</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"classe_4\">classe_4</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"Total\">Total</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"Diplome_nom\" class=\"gt_row gt_center\">Pas de scolarité ou arrêt avant la fin du primaire</td>\n<td headers=\"classe_1\" class=\"gt_row gt_right\">1.51%</td>\n<td headers=\"classe_2\" class=\"gt_row gt_right\">3.06%</td>\n<td headers=\"classe_3\" class=\"gt_row gt_right\">4.56%</td>\n<td headers=\"classe_4\" class=\"gt_row gt_right\">8.24%</td>\n<td headers=\"Total\" class=\"gt_row gt_right\">3.62%</td></tr>\n    <tr><td headers=\"Diplome_nom\" class=\"gt_row gt_center\">Aucun diplôme et scolarité interrompue à la fin du primaire ou avant la fin du collège</td>\n<td headers=\"classe_1\" class=\"gt_row gt_right\">2.29%</td>\n<td headers=\"classe_2\" class=\"gt_row gt_right\">3.90%</td>\n<td headers=\"classe_3\" class=\"gt_row gt_right\">5.67%</td>\n<td headers=\"classe_4\" class=\"gt_row gt_right\">8.93%</td>\n<td headers=\"Total\" class=\"gt_row gt_right\">4.46%</td></tr>\n    <tr><td headers=\"Diplome_nom\" class=\"gt_row gt_center\">Aucun diplôme et scolarité jusqu’à la fin du collège ou au-delà</td>\n<td headers=\"classe_1\" class=\"gt_row gt_right\">3.01%</td>\n<td headers=\"classe_2\" class=\"gt_row gt_right\">4.54%</td>\n<td headers=\"classe_3\" class=\"gt_row gt_right\">6.59%</td>\n<td headers=\"classe_4\" class=\"gt_row gt_right\">9.78%</td>\n<td headers=\"Total\" class=\"gt_row gt_right\">5.21%</td></tr>\n    <tr><td headers=\"Diplome_nom\" class=\"gt_row gt_center\">CEP (certificat d’études primaires)</td>\n<td headers=\"classe_1\" class=\"gt_row gt_right\">2.48%</td>\n<td headers=\"classe_2\" class=\"gt_row gt_right\">3.76%</td>\n<td headers=\"classe_3\" class=\"gt_row gt_right\">4.46%</td>\n<td headers=\"classe_4\" class=\"gt_row gt_right\">4.54%</td>\n<td headers=\"Total\" class=\"gt_row gt_right\">3.54%</td></tr>\n    <tr><td headers=\"Diplome_nom\" class=\"gt_row gt_center\">BEPC, brevet élémentaire, brevet des collèges, DNB</td>\n<td headers=\"classe_1\" class=\"gt_row gt_right\">6.04%</td>\n<td headers=\"classe_2\" class=\"gt_row gt_right\">7.39%</td>\n<td headers=\"classe_3\" class=\"gt_row gt_right\">8.24%</td>\n<td headers=\"classe_4\" class=\"gt_row gt_right\">9.00%</td>\n<td headers=\"Total\" class=\"gt_row gt_right\">7.31%</td></tr>\n    <tr><td headers=\"Diplome_nom\" class=\"gt_row gt_center\">CAP, BEP ou diplôme de niveau équivalent</td>\n<td headers=\"classe_1\" class=\"gt_row gt_right\">7.16%</td>\n<td headers=\"classe_2\" class=\"gt_row gt_right\">12.02%</td>\n<td headers=\"classe_3\" class=\"gt_row gt_right\">16.42%</td>\n<td headers=\"classe_4\" class=\"gt_row gt_right\">17.35%</td>\n<td headers=\"Total\" class=\"gt_row gt_right\">11.90%</td></tr>\n    <tr><td headers=\"Diplome_nom\" class=\"gt_row gt_center\">Baccalauréat général ou technologique, brevet supérieur, capacité en droit, DAEU, ESEU</td>\n<td headers=\"classe_1\" class=\"gt_row gt_right\">11.37%</td>\n<td headers=\"classe_2\" class=\"gt_row gt_right\">11.75%</td>\n<td headers=\"classe_3\" class=\"gt_row gt_right\">12.24%</td>\n<td headers=\"classe_4\" class=\"gt_row gt_right\">11.90%</td>\n<td headers=\"Total\" class=\"gt_row gt_right\">11.72%</td></tr>\n    <tr><td headers=\"Diplome_nom\" class=\"gt_row gt_center\">Baccalauréat professionnel, brevet professionnel, de technicien ou d’enseignement, diplôme équivalent</td>\n<td headers=\"classe_1\" class=\"gt_row gt_right\">3.66%</td>\n<td headers=\"classe_2\" class=\"gt_row gt_right\">5.43%</td>\n<td headers=\"classe_3\" class=\"gt_row gt_right\">6.95%</td>\n<td headers=\"classe_4\" class=\"gt_row gt_right\">7.28%</td>\n<td headers=\"Total\" class=\"gt_row gt_right\">5.36%</td></tr>\n    <tr><td headers=\"Diplome_nom\" class=\"gt_row gt_center\">BTS, DUT, Deug, Deust, diplôme de la santé ou du social de niveau bac+2, diplôme équivalent</td>\n<td headers=\"classe_1\" class=\"gt_row gt_right\">8.49%</td>\n<td headers=\"classe_2\" class=\"gt_row gt_right\">10.14%</td>\n<td headers=\"classe_3\" class=\"gt_row gt_right\">10.13%</td>\n<td headers=\"classe_4\" class=\"gt_row gt_right\">8.11%</td>\n<td headers=\"Total\" class=\"gt_row gt_right\">9.19%</td></tr>\n    <tr><td headers=\"Diplome_nom\" class=\"gt_row gt_center\">Licence, licence pro, maîtrise, diplôme équivalent de niveau bac+3 ou bac+4</td>\n<td headers=\"classe_1\" class=\"gt_row gt_right\">15.80%</td>\n<td headers=\"classe_2\" class=\"gt_row gt_right\">13.86%</td>\n<td headers=\"classe_3\" class=\"gt_row gt_right\">11.11%</td>\n<td headers=\"classe_4\" class=\"gt_row gt_right\">7.58%</td>\n<td headers=\"Total\" class=\"gt_row gt_right\">13.04%</td></tr>\n    <tr><td headers=\"Diplome_nom\" class=\"gt_row gt_center\">Master, DEA, DESS, diplôme grande école niveau bac+5, doctorat de santé</td>\n<td headers=\"classe_1\" class=\"gt_row gt_right\">35.20%</td>\n<td headers=\"classe_2\" class=\"gt_row gt_right\">22.10%</td>\n<td headers=\"classe_3\" class=\"gt_row gt_right\">12.57%</td>\n<td headers=\"classe_4\" class=\"gt_row gt_right\">6.71%</td>\n<td headers=\"Total\" class=\"gt_row gt_right\">22.68%</td></tr>\n    <tr><td headers=\"Diplome_nom\" class=\"gt_row gt_center\">Doctorat de recherche (hors santé)</td>\n<td headers=\"classe_1\" class=\"gt_row gt_right\">3.00%</td>\n<td headers=\"classe_2\" class=\"gt_row gt_right\">2.04%</td>\n<td headers=\"classe_3\" class=\"gt_row gt_right\">1.05%</td>\n<td headers=\"classe_4\" class=\"gt_row gt_right\">0.57%</td>\n<td headers=\"Total\" class=\"gt_row gt_right\">1.97%</td></tr>\n    <tr><td headers=\"Diplome_nom\" class=\"gt_row gt_center\">Total</td>\n<td headers=\"classe_1\" class=\"gt_row gt_right\">100.00%</td>\n<td headers=\"classe_2\" class=\"gt_row gt_right\">100.00%</td>\n<td headers=\"classe_3\" class=\"gt_row gt_right\">100.00%</td>\n<td headers=\"classe_4\" class=\"gt_row gt_right\">100.00%</td>\n<td headers=\"Total\" class=\"gt_row gt_right\">100.00%</td></tr>\n  </tbody>\n  \n</table>\n</div>\n```\n\n:::\n:::\n\n\nEnfin, on a vu qu'il y avait plusieurs méthodes d'agrégation, ici nous avons utilisé le critère de Ward. Il est possible de tester d'autres méthodes et de comparer les dendogrammes alors obtenus.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Etape 3 bis : on choisit d'autres méthodes d'agrégation\nclassif.s <- hclust(dist_mat, method = \"single\")\nclassif.c <- hclust(dist_mat, method = \"complete\")\nclassif.a <- hclust(dist_mat, method = \"average\")\nclassif.cd <- hclust(dist_mat, method = \"centroid\")\n\n#Etape 4 bis : on visualise les dendogrammes des 4 nouvelles méthodes + la 1ère utilisée précédemment, et on les compare sur un même graphique\npar(mfrow = c(2, 3))\nplot(classif.s, xlab=\"Commune\", main = \"Single\", label=FALSE)\nplot(classif.c, xlab=\"Commune\", main = \"Complete\", label=FALSE)\nplot(classif.a, xlab=\"Commune\", main = \"Average\", label=FALSE)\nplot(classif.cd, xlab=\"Commune\", main = \"Centroid\", label=FALSE)\nplot(classif_socioprof, xlab=\"Commune\", main = \"Ward\", label=FALSE)\n#par(mfrow = c(1, 1)\n```\n\n::: {.cell-output-display}\n![](12-Clustering-application_files/figure-html/Cght_agr-1.png){width=672}\n:::\n:::\n\n\nOn observe donc de fortes différences entre les dendogrammes. Par exemple, la méthode du \"lien simple\" ou \"minimum\" va avoir tendance à construire une grosse classe et une autre plus petite, c'est bien ce que l'on voit ici ; alors qu'au contraire, la méthode d'agrégation dite \"complete\" tend à construire des groupes plutôt de taille égale, en revanche, il faut savoir qu'elle est sensible aux points aberrants (on voit que ce n'est pas le cas ici). Enfin, on voit également que la méthode du \"centroïd\" (barycentre/centre de gravité des classes) produit un dendogramme particulier et déséquilibré comme le premier graphe (méthode du \"lien simple\"). C'est bien la méthode de Ward qui est la plus utilisée en pratique.\n\n## La méthode des *k-means* appliquée à nos données\n\nOn repart de notre table de données transformée (\"cat_soc_chi2\") et on lui applique la fonction `kmeans` de `R`. Comme décrit dans la section précédente de manière théorique, il faut : i) choisir le nombre de classes que l'on souhaite avoir avec l'option `centers=k`, pour pouvoir comparer avec la méthode précédente de la CAH, on va donc choisir le même nombre de groupe, soit 4 ; ii) et réitérer toute la procédure plusieurs fois avec des individus pris au départ qui soient différents, avec l'option `nstart=`, ici on choisit 100 essais, et la fonction prendra le meilleur pour l'algorithme.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nclust.kmeans <- kmeans(cat_soc_chi2, centers=4, nstart=100)\n\n# On affiche ensuite les résultats principaux : effectif des classes, moyenne des \n# variables actives, groupes d'affectation des individus, \n# proportion d'inertie expliquée par la partition (ici 62%)\nclust.kmeans\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nK-means clustering with 4 clusters of sizes 26, 35, 33, 42\n\nCluster means:\n  nb_Arti_com nb_Autres inactifs nb_Cadres nb_Chômeurs nb_Employés nb_Ouvriers\n1   0.1495512          0.5676564 0.1166422   0.4207642   0.4941888   0.4881346\n2   0.1581992          0.4296114 0.2578518   0.3090005   0.4645667   0.3610936\n3   0.1742342          0.3735899 0.4404954   0.2416735   0.3630235   0.2120586\n4   0.2127105          0.3745023 0.6569413   0.2130710   0.2658643   0.1188337\n      nb_PI nb_Retraités\n1 0.2981977    0.3623884\n2 0.4116066    0.4216620\n3 0.4154235    0.4903174\n4 0.3560413    0.4499791\n\nClustering vector:\n75101 75102 75103 75104 75105 75106 75107 75108 75109 75110 75111 75112 75113 \n    4     4     4     4     4     4     4     4     4     4     4     4     3 \n75114 75115 75116 75117 75118 75119 75120 92002 92004 92007 92009 92012 92014 \n    4     4     4     4     4     3     3     4     3     2     4     4     4 \n92019 92020 92022 92023 92024 92025 92026 92032 92033 92035 92036 92040 92044 \n    3     4     4     3     3     3     4     3     4     4     1     4     4 \n92046 92048 92049 92050 92051 92060 92062 92063 92064 92071 92072 92073 92075 \n    3     3     4     2     4     3     4     4     4     4     4     4     4 \n92076 92077 92078 93001 93005 93006 93007 93008 93010 93013 93014 93027 93029 \n    4     4     1     1     1     2     1     1     1     1     1     1     1 \n93030 93031 93032 93033 93039 93045 93046 93047 93048 93049 93050 93051 93053 \n    1     1     2     3     1     3     2     1     2     3     2     2     1 \n93055 93057 93059 93061 93062 93063 93064 93066 93070 93071 93072 93073 93074 \n    2     2     1     2     3     2     2     1     2     1     1     2     2 \n93077 93078 93079 94002 94003 94004 94011 94015 94016 94017 94018 94019 94021 \n    2     1     1     2     3     2     1     3     3     2     3     2     2 \n94022 94028 94033 94034 94037 94038 94041 94042 94043 94044 94046 94048 94052 \n    2     2     3     2     2     3     2     3     3     2     3     3     4 \n94054 94055 94058 94059 94060 94065 94067 94068 94069 94071 94073 94074 94075 \n    1     3     3     2     2     3     4     3     3     3     2     1     3 \n94076 94077 94078 94079 94080 94081 \n    2     2     1     2     4     2 \n\nWithin cluster sum of squares by cluster:\n[1] 0.4950321 0.6789536 0.7875165 0.9539909\n (between_SS / total_SS =  79.7 %)\n\nAvailable components:\n\n[1] \"cluster\"      \"centers\"      \"totss\"        \"withinss\"     \"tot.withinss\"\n[6] \"betweenss\"    \"size\"         \"iter\"         \"ifault\"      \n```\n\n\n:::\n:::\n\n\nOn peut comparer avec les classes obtenues précédemment avec la CAH, simplement en croisant les deux variables de classe :\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#correspondance avec les groupes de la CAH\ntable(classe4_socioprof, clust.kmeans$cluster)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                 \nclasse4_socioprof  1  2  3  4\n                1  0  0  0 39\n                2  0  5 33  3\n                3  0 28  0  0\n                4 26  2  0  0\n```\n\n\n:::\n:::\n\n\nOn voit ainsi que certaines classes de la *CAH* (les 4 lignes du tableau) coïncident exactement ou quasi-exactement avec les classes des *K-means* (en colonne), et une un peu moins car un peu plus distribuée entre plusieurs classes de la typologie des *K-means* . Autrement dit, on conclut à un changement de classes à la marge.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nclust_kmeans <- clust.kmeans$cluster %>% as.data.frame() %>% rename(\"classe4_socioprof\"=\".\") %>% rownames_to_column(\"COM\")\n\nmap_com_typo_1 <- map_com %>% select(COM, com_name, geometry) %>% \n  left_join(clust_kmeans)\nmf_theme(\"agolalight\")\nmf_map(map_com_typo_1, var=\"classe4_socioprof\", type=\"typo\", \n       pal = c(\"aquamarine3\", \"coral\", \"skyblue3\", \"brown4\"),\n       leg_pos = \"bottomleft\", leg_title=\"Cluster\",\n       col_na = \"gray80\", leg_no_data = \"Données manquantes\")\nmf_map(map_dept, var=\"nom_dep\",  type = \"base\",\n       col = NA, col_na = \"gray80\",\n       border=\"black\",lwd=1, add = TRUE)\nmf_layout(title = \"Profils PCS des communes de Paris et sa petite couronne\",\n          frame = TRUE, credits=\" \", arrow = F)\n```\n\n::: {.cell-output-display}\n![](12-Clustering-application_files/figure-html/carto kmeans-1.png){width=672}\n:::\n:::\n\n\nOn a vu avec la description de la méthode, que ce qui est difficile ici c'est qu'on choisit nous-mêmes le nombre de classes dans une première étape sans savoir parfois pourquoi. Il faut donc souvent faire varier le nombre de classes de départ (`centers=k`), à ne pas confondre avec les individus centres initiaux de classes (ce que l'on a fait précédemment en indiquant l'option `nstart=100`). A partir d'un exemple de code récupéré sur un document de cours externe ([ici](https://eric.univ-lyon2.fr/ricco/cours/didacticiels/R/cah_kmeans_avec_r.pdf)), on peut créer une boucle pour répéter la procédure en changeant le nombre de classes, et ensuite construire un graphique visualisant l'indicateur de pourcentage d'inertie expliquée. Plus précisément, on fait tourner plusieurs fois la méthode des K-means sur notre base de données centrées-réduites pour un nombre de classes souhaitées variant entre 2 et 6, et on récupère la part de l'inertie expliquée par la partition obtenue (indicateur `between_SS / total_SS` que l'on a vu dans la sortie précédente). Puis, on crée un graphique représentant cette part pour chacune des partitions construites.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Boucle pour calculer la part de l'inertie expliquée par la partition, selon le  \n# nombre de classes souhaitées\ninertie.expl <- rep(0, times=6)\nfor (k in 2:6){\n  clus <- kmeans(cat_soc_chi2, centers=k, nstart=100)  \n  inertie.expl[k] <- clus$betweenss/clus$totss}\n\n#Création du graphique\nplot(1:6, inertie.expl, type=\"b\", xlab=\"Nombre de classes choisies\", \n     ylab=\"Pourcentage d'inertie expliquée par la partition\")\n```\n\n::: {.cell-output-display}\n![](12-Clustering-application_files/figure-html/Compar_clK-means-1.png){width=672}\n:::\n:::\n\n\nOn observe sur ce graphique qu'à partir de k=3, autrement dit de 3 classes, la \"création\" d'une classe supplémentaire ne semble pas augmenter significativement la part d'inertie expliquée par la partition. Pour comprendre ce que revêt ce \"significativement\", on peut regarder notamment la pente de chaque droite reliant les points d'une partition à une autre : pour la droite reliant le nombre de classes \"2\" et \"3\", on voit que sa pente diminue déjà pas mal par rapport à la droite reliant les deux classes précédentes, et cela est encore plus visible pour les pentes suivantes.\n\nUne autre méthode évoquée par le même document de cours propose d'utiliser le package `fpc` qui propose une fonction `kmeansruns` évaluant les différentes partitions à partir de 2 critères à choisir : l'indice de Calinski Harabasz - option `criterion=\"ch\"`, ou celui de la \"average silhouette width\" (largeur moyenne de la silhouette) - option `criterion=\"asw\"`. On peut ensuite construire un graphique comme précédemment pour visualiser l'évolution de cet indice selon le nombre de classes de la partition.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# OU utilisation du package fpc et de l'indice de Calinski Harabasz  \nlibrary(fpc)\n#Evaluation des solutions\neval.kmeans <- kmeansruns(cat_soc_chi2,\n                         krange=2:6,\n                         criterion=\"ch\",)\n\n#Graphique\nplot(1:6, eval.kmeans$crit,type=\"b\", xlab=\"Nombre de classes\", \n     ylab=\"Indice de Calinski Harabasz \")\n```\n\n::: {.cell-output-display}\n![](12-Clustering-application_files/figure-html/Compar_clK-means_bis-1.png){width=672}\n:::\n:::\n\n\nPour lire et choisir le \"bon\" nombre de classes selon ce critère, il faut maximiser l'indice donc trouver le point le plus haut : ici, c'est la partition à 2 classes qui semble la \"meilleure\" typologie comme on l'avait vu dans la CAH avec le dendogramme, mais une partition a minima en 3 classes semble plus intéressante pour l'interprétation.\n",
    "supporting": [
      "12-Clustering-application_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}